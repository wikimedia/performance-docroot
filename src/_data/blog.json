{
	"feed": {
		"xmlns": "http://www.w3.org/2005/Atom",
		"title": "The speed of thought",
		"id": "https://phabricator.wikimedia.org/phame/blog/feed/7/",
		"link": {
			"rel": "self",
			"type": "application/atom+xml",
			"href": "https://phabricator.wikimedia.org/phame/blog/feed/7/"
		},
		"updated": "2018-04-08T13:13:16+00:00",
		"subtitle": "As the Wikimedia Foundation’s Performance Team, we want to create value for readers and editors by making it possible to retrieve and render content at the speed of thought, from anywhere in the world, on the broadest range of devices and connection profiles.",
		"entry": [
			{
				"title": "Thumbor support for private wikis deployed",
				"link": {
					"href": "/phame/live/7/post/86/thumbor_support_for_private_wikis_deployed/"
				},
				"id": "https://phabricator.wikimedia.org/phame/post/view/86/",
				"author": {
					"name": "Gilles (Gilles Dubuc)"
				},
				"published": "2018-02-22T10:34:43+00:00",
				"updated": "2018-02-22T16:36:28+00:00",
				"content": {
					"type": "xhtml",
					"div": {
						"xmlns": "http://www.w3.org/1999/xhtml",
						"p": [
							{
								"a": [
									{
										"href": "https://wikitech.wikimedia.org/wiki/Thumbor",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "Thumbor"
									},
									{
										"href": "https://meta.wikimedia.org/wiki/OTRS",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "OTRS"
									}
								],
								"em": "special case"
							},
							"When we migrated all public thumbnail traffic to using Thumbor as the rendering backend last June, it would have been easy to claim the job done and move onto something else, turning a blind eye to the special case of private wikis. But their different setup meant that they were still using the MediaWiki-based thumbnailing cluster. A clear waste of resources to have a whole (reduced, but still multi-machine) cluster dedicated to a special case representing so little traffic. And more importantly, it meant that for tasks like security work or software upgrades, we would have two clusters to care about for image processing, the new Thumbor one and the legacy MediaWiki image scaling. With very different testing involved for each.",
							"What makes thumbnailing different for private wikis, is that like any content on them, images are meant to be only viewed by people with access to those wikis. For public wikis, authentication isn't required, and that's what lets us have a more streamlined stack that doesn't hit MediaWiki. Public wiki thumbnails are highly cached in Varnish. For private wikis, MediaWiki's authentication acts as the gatekeeper to let a client view a thumbnail. Varnish doesn't cache the thumbnails of private wikis, and merely forwards the request to MediaWiki.",
							"With the new system deployed yesterday, when MediaWiki receives such requests for a new thumbnail on a private wiki, instead of rendering it like it used to, it proxies the request to the same Thumbor cluster used by public wikis, which takes care of the rendering. Some additional gatekeeping is in place in Thumbor to ensure that requests coming from the public wiki pipeline cannot access images that belong to private wikis. Essentially, rendering is now centralized on the single Thumbor cluster, which takes care of both worlds, while still keeping Thumbor decoupled from MediaWiki authentication (since for security reasons, we don't want Thumbor to interact with MediaWiki databases).",
							"Bar any unforeseen issues while we keep an eye on potential bugs in the coming months, we will most likely retire the MediaWiki-based image scaling cluster this year, therefore truly concluding the migration of all our thumbnail rendering across our entire infrastructure to Thumbor.",
							"Sometimes it takes a lot of extra work to tackle those special cases, which can feel like a chore after having switched 99.9% of the traffic already. But the cost of keeping a legacy system running for a special case cannot be overlooked. Beyond keeping a cluster of mostly idle machines in two data centers, the duplicated work of maintaining things is also expensive and never really quantified. Reaching true completion and decommissioning a legacy cluster feels great, though, it's really worth putting in the extra effort!"
						]
					}
				}
			},
			{
				"title": "Measuring Wikipedia page load times",
				"link": {
					"href": "/phame/live/7/post/83/measuring_wikipedia_page_load_times/"
				},
				"id": "https://phabricator.wikimedia.org/phame/post/view/83/",
				"author": {
					"name": "Krinkle (Timo Tijhof)"
				},
				"published": "2018-01-09T18:25:45+00:00",
				"updated": "2018-01-12T19:11:46+00:00",
				"content": {
					"type": "xhtml",
					"div": {
						"xmlns": "http://www.w3.org/1999/xhtml",
						"p": [
							"This post shows how we measure and interpret load times on Wikipedia. It also explains what real-user metrics are, and how percentiles work.",
							"When a browser loads a page, the page can include program code (JavaScript). This program will run inside the browser, alongside the page. This makes it possible for a page to become dynamic (more than static text and images). When you search on Wikipedia.org, the suggestions that appear are made with JavaScript.",
							"Browsers allow JavaScript to access some internal systems. One such system is Navigation Timing, which tracks how long each step takes. For example:",
							"There are two ways to measure performance: Real user monitoring, and synthetic testing. Both play an important role in understanding performance, and in detecting changes.",
							"Synthetic testing can give high confidence in change detection. To detect changes, we use an automated mechanism to continually load a page and extract a result (eg. load time). When there is a difference between results, it likely means that our website changed. This assumes other factors remained constant in the test environment. Factors such as network latency, operating system, browser version, and so on.",
							"This is good for understanding relative change. But synthetic testing does not measure the performance as perceived by users. For that, we need to collect measurements from the user’s browser.",
							"Our JavaScript code reads the measurements from Navigation Timing, and sends them back to Wikipedia.org. This is real-user monitoring.",
							"Imagine 9 users each send a request: 5 users get a result in 5ms, 3 users get a result in 70ms, and for one user the result took 560ms. The average is 88ms. But, the average does not match anyone’s real experience. Let’s explore percentiles!",
							{
								"div": {
									"class": "phabricator-remarkup-embed-layout-center",
									"a": {
										"href": "https://phab.wmfusercontent.org/file/data/siw3g2fygkjxysmeu4gv/PHID-FILE-icv5lj6kc2pldcbl23hz/figure-1-percentiles.png",
										"class": "phabricator-remarkup-embed-image",
										"data-sigil": "lightboxable",
										"data-meta": "0_0",
										"rel": "noreferrer",
										"img": {
											"src": "https://phab.wmfusercontent.org/file/data/siw3g2fygkjxysmeu4gv/PHID-FILE-icv5lj6kc2pldcbl23hz/figure-1-percentiles.png",
											"height": "100",
											"alt": "Diagram showing 9 labels: 5ms, 5ms, 5ms, 5ms, 5ms, 70ms, 70ms, 70ms, and 560ms."
										}
									}
								}
							},
							{
								"em": [
									"50th percentile",
									"75th percentile"
								]
							},
							"When working on a service used by millions, we focus on the 99th percentile and the highest value (100th percentile). Using medians, or percentiles lower than 99%, would exclude many users. A problem with 1% of requests is a serious problem. To understand why, it is important to understand that, 1% of requests does not mean 1% of page views, or even 1% of users.",
							"A typical Wikipedia pageview makes 20 requests to the server (1 document, 3 stylesheets, 4 scripts, 12 images). A typical user views 3 pages during their session (on average).",
							{
								"tt": [
									{
										"class": "remarkup-monospaced",
										"$t": "20 requests x 1% = 20% = ⅕"
									},
									{
										"class": "remarkup-monospaced",
										"$t": "3 pages x 20 objects x 1% = 60% ≈ ⅔"
									}
								]
							},
							{
								"em": [
									"back-end",
									"back-end",
									"front-end"
								]
							},
							"It takes time for the request to travel from the user’s device to our systems (through cellular or WiFi radio waves, and through wires.) It also takes time for our response to travel back over similar networks to the user’s device. Once there, it takes even more time for the device’s operating system and browser to process and display the information. Measuring this is part of front-end performance.",
							"Differences in back-end performance may affect all users. But, differences in front-end performance are influenced by factors we don’t control. Such as network quality, device hardware capability, browser, browser version, and more.",
							"Even when we make no changes, the front-end measurements do change. Possible causes:",
							"The most likely cause for a sudden change in metrics is ourselves. Given our scale, the above factors usually change only for a small number of users at once. Or the change might happen slowly.",
							"Yet, sometimes these external factors do cause a sudden change in metrics.",
							"Shortly after Apple released iOS 9 (in 2015), our global measurements were higher than before. We found this was due to Mobile Safari 9 introducing support for Navigation Timing.",
							"Before this event, our metrics only represented mobile users on Android. With iOS 9, our data increased its scope to include Mobile Safari.",
							"iOS 9, or the networks of iOS 9 users, were not significantly faster or slower than Android’s. The iOS upgrade affected our metrics because we now include an extra 15% of users – those on Mobile Safari.",
							"Where desktop latency is around 330ms; mobile latency is around 520ms. Having more metrics from mobile, skewed the global metrics toward that category.",
							"The above graphs plot the \"75th percentile\" of responseStart for desktop and mobile (from November 2015). We combine these metrics into one data point for each minute. The above graphs show data for one month. There is only enough space on the screen to have each point represent 3 hours. This works by taking the mean average of the per-minute values within each 3 hour block. While this provides a rough impression, this graph does not show the 75th percentile for November 2015. The next section explains why.",
							"Opinions vary on how bad it is to take the average of percentiles over time. But one thing is clear: The average of many 1-minute percentiles is not the percentile for those minutes. Every minute is different, and the number of values also varies each minute. To get the percentile for one hour, we need all values from that hour, not the percentile summary from each minute.",
							"Below is an example with values from three minutes of time. Each value is the response time for one request. Within each minute, the values sort from low to high.",
							{
								"div": {
									"class": "phabricator-remarkup-embed-layout-center",
									"a": {
										"href": "https://phab.wmfusercontent.org/file/data/porgzz4pytpmrn3xexh6/PHID-FILE-2miv6vsothoyeluj4qg6/figure-2.png",
										"class": "phabricator-remarkup-embed-image",
										"data-sigil": "lightboxable",
										"data-meta": "0_3",
										"rel": "noreferrer",
										"img": {
											"src": "https://phab.wmfusercontent.org/file/data/porgzz4pytpmrn3xexh6/PHID-FILE-2miv6vsothoyeluj4qg6/figure-2.png",
											"height": "512",
											"alt": "Diagram with four sections. Section One is for the minute 08:00 to 08:01, it has nine values with the middle value of 5ms marked as the median. Section Two is for 08:01 to 08:02 and contains five values, the median is 560ms. Section Three is 08:02 to 08:03, contains five values, the median of Section Three is 70ms. The last section, Section Four, is the combined diagram from 08:00 to 08:03 showing all nineteen values. The median is 70ms."
										}
									}
								}
							},
							{
								"tt": {
									"class": "remarkup-monospaced",
									"$t": "(5 + 560 + 70) / 3"
								}
							},
							"To compute the percentile over a large period, we must have all original values. But, it’s not efficient to store data about every visit to Wikipedia for a long time. We could not quickly compute percentiles either.",
							{
								"em": "histogram bin"
							},
							"Let’s process the same example values as before, but this time using buckets.",
							{
								"div": [
									{
										"class": "phabricator-remarkup-embed-layout-center",
										"a": {
											"href": "https://phab.wmfusercontent.org/file/data/4iofmmgk2rmufsk4fwfk/PHID-FILE-5qjog7zsjygzk7csj3tk/figure-3-buckets.png",
											"class": "phabricator-remarkup-embed-image",
											"data-sigil": "lightboxable",
											"data-meta": "0_4",
											"rel": "noreferrer",
											"img": {
												"src": "https://phab.wmfusercontent.org/file/data/4iofmmgk2rmufsk4fwfk/PHID-FILE-5qjog7zsjygzk7csj3tk/figure-3-buckets.png",
												"height": "463",
												"alt": "There are four buckets. Bucket A is for values below 11ms. Bucket B is for 11ms to 100ms. Bucket C is for 101ms to 1000ms. And Bucket D is for values above 1000ms. For each of the 19 values, we find the associated bucket and increase its counter."
											}
										}
									},
									{
										"class": "phabricator-remarkup-embed-layout-center",
										"a": {
											"href": "https://phab.wmfusercontent.org/file/data/czeyvgnensjxvwgrj5pq/PHID-FILE-pz4dhhb6wn67qqb67jsa/figure-4-buckets-summary.png",
											"class": "phabricator-remarkup-embed-image",
											"data-sigil": "lightboxable",
											"data-meta": "0_5",
											"rel": "noreferrer",
											"img": {
												"src": "https://phab.wmfusercontent.org/file/data/czeyvgnensjxvwgrj5pq/PHID-FILE-pz4dhhb6wn67qqb67jsa/figure-4-buckets-summary.png",
												"height": "90",
												"alt": "After processing all values, the counters are as follows. Bucket A holds 9, Bucket B holds 4, Bucket C holds 6, and Bucket D holds 0."
											}
										}
									}
								],
								"br": {}
							},
							"Based on the total count (19) we know that the median (10th value) must be in bucket B, because bucket B contains values 10 to 13. And that the 75th percentile (15th value) must be in bucket C because it contains values 14 to 19.",
							"We cannot know the exact millisecond value of the median, but we know the median must be between 11ms and 100ms. (This matches our previous calculation, which produced 70ms.)",
							"When we use exact percentiles, our goal was for that percentile to be a certain number. For example, if our 75th percentile today is 560ms, this means for 75% of users a response takes 560ms or less. Our goal could be to reduce the 75th percentile to below 500ms.",
							"When using buckets, goals are defined differently. In our example, 6 out of 19 responses (32%) are above 100ms (bucket C and D), and 13 of 19 (68%) are below 100ms (bucket A and B). Our goal could be to reduce the percentage of responses above 100ms. Or the opposite, to increase the percentage of responses within 100ms.",
							"Traffic trends are generally moving towards mobile. In fact, April 2017 was the first month where Wikimedia mobile pageviews reached 50% of all Wikimedia pageviews. And after June 2017, mobile traffic has stayed above 50%.",
							{
								"div": {
									"class": "phabricator-remarkup-embed-layout-center",
									"a": {
										"href": "https://phab.wmfusercontent.org/file/data/2tpgogf2g34qggfx6rag/PHID-FILE-7scdbt4qdznn4noohg5q/blog-image-platform-percent.png",
										"class": "phabricator-remarkup-embed-image",
										"data-sigil": "lightboxable",
										"data-meta": "0_6",
										"rel": "noreferrer",
										"img": {
											"src": "https://phab.wmfusercontent.org/file/data/2tpgogf2g34qggfx6rag/PHID-FILE-7scdbt4qdznn4noohg5q/blog-image-platform-percent.png",
											"height": "159",
											"alt": "Bar chart showing percentages of mobile and desktop pageviews for each month in 2017. They mostly swing equal at around 50%. Looking closely, we see mobile first reaches 51% in April. In May it was below 50% again. But for June and every month since then mobile has remained above 50%. The peak was in October 2017, where mobile accounted for 59% of pageviews. The last month in the graph, November 2017 shows 53% of mobile pageviews."
										}
									}
								}
							},
							"Global changes like this have a big impact on our measurements. This is the kind of change that drives us to rethink how we measure performance, and (more importantly) what we monitor.",
							"In the next post we’ll discuss how we aggregate this data, and which metrics we monitor on our dashboards."
						],
						"h3": [
							{
								"class": "remarkup-header",
								"$t": "Navigation Timing"
							},
							{
								"class": "remarkup-header",
								"$t": "Where to measure: Real-user and synthetic"
							},
							{
								"class": "remarkup-header",
								"$t": "How to measure: Percentiles"
							},
							{
								"class": "remarkup-header",
								"$t": "Real-user variables"
							},
							{
								"class": "remarkup-header",
								"$t": "Case in point: Mobile Safari 9"
							},
							{
								"class": "remarkup-header",
								"$t": "Average of percentiles"
							},
							{
								"class": "remarkup-header",
								"$t": "Buckets"
							},
							{
								"class": "remarkup-header",
								"$t": "Rise of mobile"
							},
							{
								"class": "remarkup-header",
								"$t": "Further reading"
							}
						],
						"ul": [
							{
								"class": "remarkup-list",
								"li": [
									{
										"class": "remarkup-list-item",
										"$t": "How long to establish a connection to the server?"
									},
									{
										"class": "remarkup-list-item",
										"$t": "When did the response from the server start arriving?"
									},
									{
										"class": "remarkup-list-item",
										"$t": "When did the browser finish loading the page?"
									}
								]
							},
							{
								"class": "remarkup-list",
								"li": [
									{
										"class": "remarkup-list-item",
										"strong": "Network"
									},
									{
										"class": "remarkup-list-item",
										"strong": "Device"
									},
									{
										"class": "remarkup-list-item",
										"strong": "Content change"
									},
									{
										"class": "remarkup-list-item",
										"strong": "Content choice"
									},
									{
										"class": "remarkup-list-item",
										"strong": "Device choice"
									}
								]
							},
							{
								"class": "remarkup-list",
								"li": [
									{
										"class": "remarkup-list-item",
										"a": {
											"href": "https://www.mediawiki.org/wiki/Wikimedia_Performance_Team",
											"class": "remarkup-link",
											"rel": "noreferrer",
											"$t": "Wikimedia Performance Team"
										}
									},
									{
										"class": "remarkup-list-item",
										"a": {
											"href": "https://www.w3.org/TR/navigation-timing-2/",
											"class": "remarkup-link",
											"rel": "noreferrer",
											"$t": "Navigation Timing Level 2"
										}
									},
									{
										"class": "remarkup-list-item",
										"a": {
											"href": "https://www.infoq.com/presentations/latency-response-time",
											"class": "remarkup-link",
											"rel": "noreferrer",
											"$t": "\"How Not To Measure Latency\""
										}
									},
									{
										"class": "remarkup-list-item",
										"a": {
											"href": "https://howdns.works/",
											"class": "remarkup-link",
											"rel": "noreferrer",
											"$t": "How DNS Works"
										}
									},
									{
										"class": "remarkup-list-item",
										"a": {
											"href": "https://en.wikipedia.org/wiki/Domain_Name_System",
											"class": "remarkup-link",
											"rel": "noreferrer",
											"$t": "\"Domain Name System (DNS)\""
										}
									},
									{
										"class": "remarkup-list-item",
										"a": {
											"href": "https://en.wikipedia.org/wiki/Transmission_Control_Protocol",
											"class": "remarkup-link",
											"rel": "noreferrer",
											"$t": "\"Transmission Control Protocol (TCP)\""
										}
									},
									{
										"class": "remarkup-list-item",
										"a": {
											"href": "https://en.wikipedia.org/wiki/HTTPS",
											"class": "remarkup-link",
											"rel": "noreferrer",
											"$t": "\"HTTPS\""
										}
									}
								]
							}
						],
						"div": {
							"class": "remarkup-table-wrap",
							"table": {
								"class": "remarkup-table",
								"tr": [
									{
										"td": [
											{
												"div": {
													"class": "phabricator-remarkup-embed-layout-left",
													"a": {
														"href": "https://phab.wmfusercontent.org/file/data/oilmhyhrdbtjqehaze2q/PHID-FILE-3lxaj6g7pshsh2yvd4ug/blog-image-01.png",
														"class": "phabricator-remarkup-embed-image",
														"data-sigil": "lightboxable",
														"data-meta": "0_1",
														"rel": "noreferrer",
														"img": {
															"src": "https://phab.wmfusercontent.org/file/data/oilmhyhrdbtjqehaze2q/PHID-FILE-3lxaj6g7pshsh2yvd4ug/blog-image-01.png",
															"height": "154",
															"alt": "Line graph for responseStart metric from desktop pageviews. Values range from 250ms to 450ms. Averaging around 330ms."
														}
													}
												}
											},
											{
												"div": {
													"class": "phabricator-remarkup-embed-layout-left",
													"a": {
														"href": "https://phab.wmfusercontent.org/file/data/cimqlkthg53uq4c7e7yw/PHID-FILE-qv67annefhzfalj46cn5/blog-image-02.png",
														"class": "phabricator-remarkup-embed-image",
														"data-sigil": "lightboxable",
														"data-meta": "0_2",
														"rel": "noreferrer",
														"img": {
															"src": "https://phab.wmfusercontent.org/file/data/cimqlkthg53uq4c7e7yw/PHID-FILE-qv67annefhzfalj46cn5/blog-image-02.png",
															"height": "156",
															"alt": "Line graph for responseStart metric from mobile pageviews. Values range from 350ms to 700ms. Averaging around 520ms."
														}
													}
												}
											}
										]
									},
									{}
								]
							}
						}
					}
				}
			},
			{
				"title": "The journey to Thumbor, part 3: development and deployment strategy",
				"link": {
					"href": "/phame/live/7/post/81/the_journey_to_thumbor_part_3_development_and_deployment_strategy/"
				},
				"id": "https://phabricator.wikimedia.org/phame/post/view/81/",
				"author": {
					"name": "Gilles (Gilles Dubuc)"
				},
				"published": "2017-11-20T12:42:50+00:00",
				"updated": "2017-12-23T02:13:07+00:00",
				"content": {
					"type": "xhtml",
					"div": {
						"xmlns": "http://www.w3.org/1999/xhtml",
						"p": [
							{
								"a": {
									"href": "https://phabricator.wikimedia.org/phame/post/view/80/the_journey_to_thumbor_part_2_thumbnailing_architecture/",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "where Thumbor fits in our media thumbnailing stack"
								}
							},
							{
								"a": [
									{
										"href": "https://www.mediawiki.org/wiki/MediaWiki-Vagrant",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "MediaWiki Vagrant"
									},
									{
										"href": "https://phabricator.wikimedia.org/p/bd808/",
										"class": "phui-tag-view phui-tag-type-person ",
										"data-sigil": "hovercard",
										"data-meta": "0_8",
										"rel": "noreferrer",
										"span": {
											"class": "phui-tag-core phui-tag-color-person",
											"$t": "@bd808"
										}
									}
								]
							},
							"This phase actually represented the bulk of the work, reproducing support for all the media formats and special parameters found in Mediawiki thumbnailing. I dedicated a lot of attention to making sure that the images generated by Thumbor were as good as what MediaWiki was outputting for the same original media. In order to do that, I wrote many integration tests using thumbnails from Wikimedia production, which were used as reference output. Those tests are still part of the Thumbor plugins Debian package and ensure that we avoid regressions. They use a DSSIM algorithm to visually compare images and make sure that what Thumbor outputs doesn't visually diverge from the  reference thumbnails. We also compare file size to make sure that the new output isn't significantly heavier than the old.",
							{
								"a": [
									{
										"href": "https://phabricator.wikimedia.org/p/fgiunchedi/",
										"class": "phui-tag-view phui-tag-type-person ",
										"data-sigil": "hovercard",
										"data-meta": "0_7",
										"rel": "noreferrer",
										"span": {
											"class": "phui-tag-core phui-tag-color-person",
											"$t": "@fgiunchedi"
										}
									},
									{
										"href": "https://ftp-master.debian.org/new/thumbor_6.3.2-1.html",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "Thumbor submitted to Debian unstable"
									}
								]
							},
							"One advantage of doing this is that it makes deployment of updates really straightforward, with the integration test suite I mentioned earlier running in isolation when the Debian package is built. With those Debian packages done, we were ready to run this on production machines.",
							"But the more important advantage is that by having those Debian packages into Debian itself, other people are using the exact same versions of Thumbor's dependencies and Thumbor itself via Debian, thus greatly expanding the exposure of the software we run in production. This increases the likelihood that security issues we might be exposed to are found and fixed.",
							{
								"a": {
									"href": "https://www.mediawiki.org/wiki/Beta_Cluster",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "the Beta cluster"
								}
							},
							"Just like packaging, this new step revealed bugs in the Thumbor plugins Python code that we were able to fix before hitting production.",
							"The Beta wikis only have a small selection of media, and as such we still hadn't been exposed to the variety of content found on production wikis. I was worried that we would run into media files that had special properties in production that we hadn't run into in all the development phase. Which is why I came up with a plan to dual-serve all production requests to the new production Thumbor machines and compare output.",
							"This consisted in modifications to the production Swift proxy plugin code we have in place to rewrite Wikimedia URLs. Instead of sending thumbnail requests to just MediaWiki, I modified it to also send the same requests to Thumbor. At first completely blindly, the Swift proxy would send requests to Thumbor and not even wait to see the outcome.",
							"Then I looked at the Thumbor error logs and found several files that were problematic for Thumbor and not for MediaWiki. This allowed us to fix many bugs that we would have normally found out about during the actual launch. This was also the opportunity to reproduce and iron out the various throttling mechanisms.",
							"To be more thorough, I mage the Swift proxy log HTTP status codes returned by MediaWiki and Thumbor and produced a diff, looking for files that were problematic for one and not the other. This allowed us to find more bugs on the Thumbor side, and a few instances of files that Thumbor could render properly that MediaWiki couldn't!",
							"This is also the phase where under the full production load, our Thumbor configuration started showing significant issues around memory consumption and leaks. We were able to fix all those problems in that fire-and-forget dual serving setup, with no impact at all on production traffic. This was an extremely valuable strategy, as we were able to iterate quickly in the same traffic conditions as if the service had actually launched, without any consequences for users.",
							"With Thumbor running smoothly on production machines,  successfully rendering a superset of thumbnails MediaWiki was able to, it was time to launch. The dual-serving logic in the Swift proxy came in very handy: it became a simple toggle between sending thumbnailing traffic to MediaWiki and sending it to Thumbor. And so we did switch. We did that gradually, having more and more wikis's thumbnails rendered by Thumbor over the course of a couple of weeks. The load was handled fine (predictable, since we were handling the same load in the dual-serving mode). The success rate of requests based on HTTP status codes was the same before and after.",
							"However after some time we started getting reports of issues around EXIF orientation. A feature we had integration tests for. But the tests only covered 180 degrees rotation and not 90 degrees (doh!). The Swift proxy switch allowed us to quickly switch traffic back to MediaWiki. We did so because it's quite a prevalent feature in JPGs. We fixed that one large bug, switched the traffic back to Thumbor and that was it.",
							"Some minor bugs surfaced later regarding much less common files with special properties, that we were able to fix very quickly. And deploy fixes for safely and easily with the Debian package. But we could have avoided all of those bugs too if we had been more thorough in the dual-serving phase. We were only comparing HTTP status codes between MediaWiki and Thumbor. However, rendering a thumbnail successfully doesn't mean that the visual contents are right! The JPG orientation could be wrong, for example. If I had to do it again, I would have run DSSIM visual comparisons on the live dual-served production traffic between the MediaWiki and Thumbor outputs. That would have definitely surfaced the handful of bugs that appeared post-launch.",
							"All in all, if you do your homework and are very thorough in testing locally and on production traffic, you can achieve a very smooth launch replacing a core part of infrastructure with completely different software. Despite the handful of avoidable bugs that appeared around the launch, the switch to Thumbor went largely unnoticed by users, which was the original intent, as we were looking for feature parity and ease of swapping the new solution in. Thumbor has been happily serving all Wikimedia production thumbnail traffic since June 2017 in a very stable fashion. This concludes our journey to Thumbor :)"
						],
						"h2": [
							{
								"class": "remarkup-header",
								"$t": "Development"
							},
							{
								"class": "remarkup-header",
								"$t": "Packaging"
							},
							{
								"class": "remarkup-header",
								"$t": "Beta"
							},
							{
								"class": "remarkup-header",
								"$t": "Pre-production"
							},
							{
								"class": "remarkup-header",
								"$t": "Production"
							},
							{
								"class": "remarkup-header",
								"$t": "Conclusion"
							}
						]
					}
				}
			},
			{
				"title": "The journey to Thumbor, part 2: thumbnailing architecture",
				"link": {
					"href": "/phame/live/7/post/80/the_journey_to_thumbor_part_2_thumbnailing_architecture/"
				},
				"id": "https://phabricator.wikimedia.org/phame/post/view/80/",
				"author": {
					"name": "Gilles (Gilles Dubuc)"
				},
				"published": "2017-11-17T15:17:26+00:00",
				"updated": "2017-12-13T16:14:29+00:00",
				"content": {
					"type": "xhtml",
					"div": {
						"xmlns": "http://www.w3.org/1999/xhtml",
						"p": [
							{
								"a": {
									"href": "https://wikitech.wikimedia.org/wiki/Thumbor",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "Thumbor"
								}
							},
							{
								"a": {
									"href": "https://phabricator.wikimedia.org/phame/post/view/55/the_journey_to_thumbor_part_1_rationale/",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "a previous blog post"
								}
							},
							"Like everything we serve to readers, thumbnails are heavily cached. Unlike wiki pages, there is no distinction in caching of thumbnails between readers and editors, in fact. Our edge is Nginx providing SSL termination, behind which we find Varnish clusters (both frontends and backend), which talk to OpenStack Swift - responsible for storing media originals as well as thumbnails - and finally Swift talks to Thumbor (previously MediaWiki).",
							"Nginx concerns itself with SSL and HTTP/2, because Varnish as a project decided to draw a line about Varnish's concerns and exclude HTTP/2 support from it.",
							{
								"a": {
									"href": "https://wikitech.wikimedia.org/wiki/Varnish",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "Varnish"
								}
							},
							{
								"a": {
									"href": "https://wikitech.wikimedia.org/wiki/Swift",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "Swift"
								}
							},
							"Thumbor concerns itself with generating thumbnails from original media. When it receives a request from Swift, it requests the corresponding original media from Swift, generates the required thumbnail from that original and returns it. This response is sent back up the call chain, all the way to the client, through Swift and Varnish. After that response is sent, Thumbor saves that thumbnail in Swift. Varnish, as it sees the response go through, keeps a copy as well.",
							{
								"a": [
									{
										"href": "https://www.ffmpeg.org/",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "Ffmpeg's"
									},
									{
										"href": "https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "range requests"
									}
								]
							},
							"We wanted a thumbnailing service that was \"dumb\", i.e. didn't concern itself with more than thumbnailing. Thumbor definitely provided that, but was too simple for our existing needs, which is why we had to write a number of plugins for it, to add the following features:",
							"We also changed the images included in the Thumbor project to be respectful of open licenses and wrote Debian packages for all of Thumbor's dependencies and Thumbor itself.",
							"While Thumbor was a good match on the separation of concerns we were looking for, it still required writing many plugins and a lot of extra work to make it a drop-in replacement for MediaWiki's media thumbnailing code. The main reason being that Wikimedia sites support types of media files that the web at large cares less about, like giant TIFFs and PDFs.",
							"In the next blog post, I'll describe the development strategy that led to the successful deployment of Thumbor in production."
						],
						"h2": [
							{
								"class": "remarkup-header",
								"$t": "The stack"
							},
							{
								"class": "remarkup-header",
								"$t": "The request lifecycle"
							},
							{
								"class": "remarkup-header",
								"$t": "What's out of scope"
							},
							{
								"class": "remarkup-header",
								"$t": "What we needed to add"
							},
							{
								"class": "remarkup-header",
								"$t": "Conclusion"
							}
						],
						"ul": {
							"class": "remarkup-list",
							"li": [
								{
									"class": "remarkup-list-item",
									"$t": "New media formats (XCF, DJVU, PDF, WEBM, etc.)"
								},
								{
									"class": "remarkup-list-item",
									"$t": "Smarter handling of giant originals (>1GB) to save memory"
								},
								{
									"class": "remarkup-list-item",
									"$t": "The ability to run multiple format engines at once"
								},
								{
									"class": "remarkup-list-item",
									"$t": "Support for multipage media"
								},
								{
									"class": "remarkup-list-item",
									"$t": "Handling the Wikimedia thumbnail URL format"
								},
								{
									"class": "remarkup-list-item",
									"$t": "Loading originals from Swift"
								},
								{
									"class": "remarkup-list-item",
									"$t": "Loading videos efficiently with range requests"
								},
								{
									"class": "remarkup-list-item",
									"$t": "Saving thumbnails in Swift"
								},
								{
									"class": "remarkup-list-item",
									"$t": "Various forms of throttling"
								},
								{
									"class": "remarkup-list-item",
									"a": {
										"href": "https://github.com/ionelmc/python-manhole",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "Manhole"
									}
								},
								{
									"class": "remarkup-list-item",
									"$t": "Sending logs to ELK"
								},
								{
									"class": "remarkup-list-item",
									"$t": "Wikimedia-specific filters/settings, such as conditional sharpening of JPGs"
								}
							]
						}
					}
				}
			},
			{
				"title": "The journey to Thumbor, part 1: rationale",
				"link": {
					"href": "/phame/live/7/post/55/the_journey_to_thumbor_part_1_rationale/"
				},
				"id": "https://phabricator.wikimedia.org/phame/post/view/55/",
				"author": {
					"name": "Gilles (Gilles Dubuc)"
				},
				"published": "2017-06-20T15:33:17+00:00",
				"updated": "2017-12-13T16:14:49+00:00",
				"content": {
					"type": "xhtml",
					"div": {
						"xmlns": "http://www.w3.org/1999/xhtml",
						"p": [
							{
								"a": {
									"href": "https://github.com/thumbor/thumbor",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "Thumbor"
								}
							},
							{
								"a": {
									"href": "https://phabricator.wikimedia.org/T121388",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "a year and a half ago"
								}
							},
							"The biggest reason to change the status quo is security. Since MediaWiki is quite monolithic, deployments of MediaWiki on our server fleet responsible for generating thumbnails aren't as isolated as they could be from the rest of our infrastructure.",
							{
								"a": [
									{
										"href": "https://www.cvedetails.com/vulnerability-list/vendor_id-7294/Libpng.html",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "a frequent security breach vector"
									},
									{
										"href": "https://github.com/netblue30/firejail",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "firejail"
									}
								]
							},
							"One possibility would have been to rewrite the MediaWiki code responsible for thumbnailing, turning it into a series of PHP libraries, that could then be run without MediaWiki, to perform the thumbnailing work we are currently doing - while untangling the code enough that the thumbnailing servers can be more isolated.",
							"However such a rewrite would be very expensive and when we can afford to, we prefer to use ready-made open source solutions with a community of their own, rather than writing new tools. It seemed to us that media thumbnailing was far from being a MediaWiki-specific problem and there ought to be open source solutions tackling that issue. We undertook a review of the open source landscape for this problem domain and Thumbor emerged as the clear leader in that area.",
							"The MediaWiki code responsible for thumbnailing currently doesn't have any team ownership at the Wikimedia Foundation.  It's maintained by volunteers (including some WMF staff acting in a volunteer capacity). However, the amount of contributors is very low and technical debt is accumulating.",
							{
								"a": [
									{
										"href": "https://github.com/thumbor/thumbor/graphs/contributors",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "a very active open-source project with many contributors"
									},
									{
										"href": "https://en.wikipedia.org/wiki/Grupo_Globo",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "Globo"
									}
								]
							},
							{
								"a": {
									"href": "https://github.com/thumbor/thumbor/commits?author=gi11es",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "a number of upstream changes"
								}
							},
							{
								"a": {
									"href": "https://phabricator.wikimedia.org/diffusion/THMBREXT/",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "Wikimedia-specific Thumbor plugins"
								}
							},
							"For operational purposes, running parts of the wiki workflow as isolated services is always beneficial. It enables us to set up the best fencing possible for security purposes, where Thumbor only has access to what it needs. This limits the amount of damage possible in case of a security vulnerability propagated through media files.",
							"From monitoring, to resource usage control and upstream security updates, running our media thumbnailing as a service has significant operational upsides.",
							{
								"a": [
									{
										"href": "http://thumbor.readthedocs.io/en/latest/detection_algorithms.html#facial-detection",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "feature detection"
									},
									{
										"href": "http://thumbor.readthedocs.io/en/latest/filters.html",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "filters"
									}
								]
							},
							"At this time, however, we're only aiming to deploy Thumbor to Wikimedia production as a drop-in replacement for MediaWiki thumbnailing, targeting feature parity with the status quo.",
							{
								"a": {
									"href": "https://phabricator.wikimedia.org/diffusion/THMBREXT/",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "Wikimedia-specific code footprint is small"
								}
							},
							{
								"a": [
									{
										"href": "https://en.wikipedia.org/wiki/WebP",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "WebP"
									},
									{
										"href": "http://thumbor.readthedocs.io/en/latest/format.html?highlight=webp",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "built-in feature of Thumbor"
									}
								]
							},
							"Those many factors contributed to us betting on Thumbor. Soon it will be put to the test of Wikimedia production where not only the scale of our traffic but also the huge diversity of media files we host make thumbnailing a challenge.",
							"In the next blog post, I'll describe the architecture of our production thumbnailing pipeline in detail and where Thumbor fits into it."
						],
						"h2": [
							{
								"class": "remarkup-header",
								"$t": "Security"
							},
							{
								"class": "remarkup-header",
								"$t": "Maintenance"
							},
							{
								"class": "remarkup-header",
								"$t": "Service-oriented architecture"
							},
							{
								"class": "remarkup-header",
								"$t": "New features"
							},
							{
								"class": "remarkup-header",
								"$t": "Performance"
							},
							{
								"class": "remarkup-header",
								"$t": "Conclusion"
							}
						]
					}
				}
			},
			{
				"title": "Looking back: improvements to edit save time",
				"link": {
					"href": "/phame/live/7/post/54/looking_back_improvements_to_edit_save_time/"
				},
				"id": "https://phabricator.wikimedia.org/phame/post/view/54/",
				"author": {
					"name": "Gilles (Gilles Dubuc)"
				},
				"published": "2017-06-12T09:32:27+00:00",
				"updated": "2017-06-14T01:56:51+00:00",
				"content": {
					"type": "xhtml",
					"div": {
						"xmlns": "http://www.w3.org/1999/xhtml",
						"p": [
							{
								"a": [
									{
										"href": "https://meta.wikimedia.org/wiki/Wikimedia_Foundation_Annual_Plan/2016-2017/Final",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "annual plan"
									},
									{
										"href": "https://meta.wikimedia.org/wiki/Wikimedia_Foundation_Annual_Plan/2016-2017/Final#Program_4:_Improve_site_performance",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "goals this past year"
									}
								]
							},
							{
								"a": {
									"href": "https://grafana.wikimedia.org/dashboard/db/save-timing",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "publicly tracked on Grafana"
								}
							},
							"We distinguish the amount of time the backend takes to process the edit, from the amount of time the end-user actually experiences to save the edit (collected client-side). We'll focus on the latter, as this is what people really experience. Backend traffic can come from bots, jobs, etc. where long execution times atypical of human edits affect the metrics.",
							"Let's look at the evolution of frontend save timing since the beginning of the financial year, on July 1st 2016.",
							"The 99th percentile, which represents the slowest editors experience dropped significantly:",
							{
								"div": {
									"class": "phabricator-remarkup-embed-layout-left",
									"a": {
										"href": "https://phab.wmfusercontent.org/file/data/xcsqjnaiujgegagkowna/PHID-FILE-7p54mtjy4bmf5vid2cfv/Capture_d_e%CC%81cran_2017-06-08_11.13.49.png",
										"class": "phabricator-remarkup-embed-image-full",
										"data-sigil": "lightboxable",
										"data-meta": "0_9",
										"rel": "noreferrer",
										"img": {
											"src": "https://phab.wmfusercontent.org/file/data/xcsqjnaiujgegagkowna/PHID-FILE-7p54mtjy4bmf5vid2cfv/Capture_d_e%CC%81cran_2017-06-08_11.13.49.png",
											"height": "573",
											"width": "1135"
										}
									}
								}
							},
							{
								"strong": "25% improvement"
							},
							"So did the median:",
							{
								"div": {
									"class": "phabricator-remarkup-embed-layout-left",
									"a": {
										"href": "https://phab.wmfusercontent.org/file/data/ihjmbhik5oddayd2rliy/PHID-FILE-c5d2yobmaymeebks2osu/Capture_d_e%CC%81cran_2017-06-08_11.13.38.png",
										"class": "phabricator-remarkup-embed-image-full",
										"data-sigil": "lightboxable",
										"data-meta": "0_10",
										"rel": "noreferrer",
										"img": {
											"src": "https://phab.wmfusercontent.org/file/data/ihjmbhik5oddayd2rliy/PHID-FILE-c5d2yobmaymeebks2osu/Capture_d_e%CC%81cran_2017-06-08_11.13.38.png",
											"height": "576",
											"width": "1132"
										}
									}
								}
							},
							{
								"strong": "15% improvement"
							},
							{
								"a": {
									"href": "https://phabricator.wikimedia.org/p/aaron/",
									"class": "phui-tag-view phui-tag-type-person ",
									"data-sigil": "hovercard",
									"data-meta": "0_11",
									"rel": "noreferrer",
									"span": {
										"class": "phui-tag-core phui-tag-color-person",
										"$t": "@aaron"
									}
								}
							}
						]
					}
				}
			},
			{
				"title": "Improving time-to-logo performance with preload links",
				"link": {
					"href": "/phame/live/7/post/19/improving_time-to-logo_performance_with_preload_links/"
				},
				"id": "https://phabricator.wikimedia.org/phame/post/view/19/",
				"author": {
					"name": "Gilles (Gilles Dubuc)"
				},
				"published": "2017-06-07T07:38:43+00:00",
				"updated": "2017-06-08T11:07:20+00:00",
				"content": {
					"type": "xhtml",
					"div": {
						"xmlns": "http://www.w3.org/1999/xhtml",
						"p": [
							"One of the goals of the  Wikimedia Performance Team is to improve the performance of MediaWiki and the broader software stack used on Wikimedia wikis. In this article we’ll describe a small performance improvement we’ve implemented for MediaWiki and recently deployed to production for Wikimedia. It highlights some of the unique problems we encounter on Wikimedia sites and how new web standards can be leveraged to improve performance.",
							{
								"a": [
									{
										"href": "https://www.mediawiki.org/wiki/Manual:$wgLogo",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "MediaWiki logo"
									},
									{
										"href": "https://developer.mozilla.org/en/docs/Web/CSS/background-image?v=control",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "CSS background image"
									}
								]
							},
							"In the loading sequence of a web page, browsers will give a relatively low priority to CSS background images. In practice, assuming an empty browser cache, this means that the MediaWiki logo loads quite late, after most images that are part of the page content have been loaded. To the viewer, this results in the page loading somewhat out of order: images that aren’t necessarily in view are loaded first, and the logo is one of the last images to be loaded. This breaks the de facto expectation that a web page’s content loads from top to bottom.",
							"This phenomenon extends the average duration of an imaginary metric one could call time-to-logo. The point in time when the logo appears is an important mental milestone, as it’s when a visitor has visual confirmation that they’ve landed on the right website. The issue of time-to-logo being high due to the CSS background limitation is felt even more on slow internet connections, where the logo can take seconds to appear - long after the page’s text and other images lower than the logo on the page have been loaded.",
							{
								"a": [
									{
										"href": "https://w3c.github.io/preload/",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "preload link keyword"
									},
									{
										"href": "https://developer.mozilla.org/en-US/docs/Web/CSS/Media_Queries/Using_media_queries",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "CSS media queries"
									}
								]
							},
							{
								"a": {
									"href": "https://www.w3.org/wiki/LinkHeader",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "<link> tags can be passed as response headers"
								}
							},
							{
								"a": {
									"href": "https://www.sitespeed.io/",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "Sitespeed.io"
								}
							},
							{
								"div": {
									"class": "embedded-commons-video",
									"iframe": {
										"width": "650",
										"height": "400",
										"style": "margin: 1em auto; border: 0px;",
										"src": "https://commons.wikimedia.org/wiki/File:Barack_Obama_article_on_enwiki_before_and_after_logo_loading_priority_change.webm?embedplayer=yes",
										"frameborder": "0"
									}
								}
							},
							{
								"a": {
									"href": "https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/view",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "First Meaningful Paint"
								}
							},
							"In our case, the difference seen in synthetic testing is dramatic enough that have a high level of confidence that it has made the user experience better in the real world for many people.",
							{
								"a": {
									"href": "http://caniuse.com/#feat=link-rel-preload",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "isn’t supported by all major web browsers yet"
								}
							}
						],
						"h2": [
							{
								"class": "remarkup-header",
								"$t": "Logo as CSS background"
							},
							{
								"class": "remarkup-header",
								"$t": "The preload link"
							},
							{
								"class": "remarkup-header",
								"$t": "Measuring the impact"
							}
						],
						"div": {
							"class": "remarkup-code-block",
							"data-code-lang": "text",
							"data-sigil": "remarkup-code-block",
							"pre": {
								"class": "remarkup-code",
								"$t": "Link: </static/images/project-logos/enwiki.png>;rel=preload;as=image;media=not all and (min-resolution:1.5dppx),</static/images/project-logos/enwiki-1.5x.png>;rel=preload;as=image;media=(min-resolution:1.5dppx) and (max-resolution:1.999999dppx),</static/images/project-logos/enwiki-2x.png>;rel=preload;as=image;media=(min-resolution:2dppx)"
							}
						}
					}
				}
			},
			{
				"title": "Investigating a performance improvement",
				"link": {
					"href": "/phame/live/7/post/15/investigating_a_performance_improvement/"
				},
				"id": "https://phabricator.wikimedia.org/phame/post/view/15/",
				"author": {
					"name": "Gilles (Gilles Dubuc)"
				},
				"published": "2017-06-02T10:02:37+00:00",
				"updated": "2017-06-05T08:57:58+00:00",
				"content": {
					"type": "xhtml",
					"div": {
						"xmlns": "http://www.w3.org/1999/xhtml",
						"p": [
							{
								"a": [
									{
										"href": "https://phabricator.wikimedia.org/p/Jdlrobson/",
										"class": "phui-tag-view phui-tag-type-person ",
										"data-sigil": "hovercard",
										"data-meta": "0_24",
										"rel": "noreferrer",
										"span": {
											"class": "phui-tag-core phui-tag-color-person",
											"$t": "@Jdlrobson"
										}
									},
									{
										"href": "https://wikitech.wikimedia.org/wiki/WebPageTest",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "WebPageTest"
									},
									{
										"href": "https://sites.google.com/a/webpagetest.org/docs/using-webpagetest/metrics/speed-index",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "SpeedIndex"
									}
								]
							},
							{
								"div": {
									"class": "phabricator-remarkup-embed-layout-left",
									"a": {
										"href": "https://phab.wmfusercontent.org/file/data/25msxmscf7gy3exjf7ef/PHID-FILE-ivbh5b67gslggechbyip/Capture_d_e%CC%81cran_2017-05-26_11.37.35.png",
										"class": "phabricator-remarkup-embed-image-full",
										"data-sigil": "lightboxable",
										"data-meta": "0_12",
										"rel": "noreferrer",
										"img": {
											"src": "https://phab.wmfusercontent.org/file/data/25msxmscf7gy3exjf7ef/PHID-FILE-ivbh5b67gslggechbyip/Capture_d_e%CC%81cran_2017-05-26_11.37.35.png",
											"height": "463",
											"width": "1132"
										}
									}
								}
							},
							{
								"a": [
									{
										"href": "https://sites.google.com/a/webpagetest.org/docs/using-webpagetest/metrics/speed-index",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "SpeedIndex"
									},
									{
										"href": "https://twitter.com/patmeenan",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "Pat Meenan"
									},
									{
										"href": "https://wikitech.wikimedia.org/wiki/WebPageTest",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "WebPageTest"
									}
								]
							},
							{
								"a": {
									"href": "https://phabricator.wikimedia.org/p/Jdlrobson/",
									"class": "phui-tag-view phui-tag-type-person ",
									"data-sigil": "hovercard",
									"data-meta": "0_23",
									"rel": "noreferrer",
									"span": {
										"class": "phui-tag-core phui-tag-color-person",
										"$t": "@Jdlrobson"
									}
								}
							},
							{
								"a": [
									{
										"href": "/tag/performance-team/",
										"class": "phui-tag-view phui-tag-type-shade phui-tag-violet phui-tag-shade phui-tag-icon-view ",
										"data-sigil": "hovercard",
										"data-meta": "0_22",
										"span": {
											"class": "phui-tag-core ",
											"span": {
												"class": "visual-only phui-icon-view phui-font-fa fa-users",
												"data-meta": "0_21",
												"aria-hidden": "true"
											},
											"$t": "Performance-Team"
										}
									},
									{
										"href": "/T166373",
										"class": "phui-tag-view phui-tag-type-object ",
										"data-sigil": "hovercard",
										"data-meta": "0_17",
										"span": {
											"class": "phui-tag-core-closed",
											"span": {
												"class": "phui-tag-core phui-tag-color-object",
												"$t": "T166373: Investigate apparent performance improvement around 2017-05-24"
											}
										}
									}
								]
							},
							{
								"a": {
									"href": "https://grafana.wikimedia.org/dashboard/db/navigation-timing?refresh=5m&orgId=1",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "Navigation Timing in Grafana"
								}
							},
							"SpeedIndex can't be measured on real users. Real user metrics are limited by the APIs available in browser, which are very basic compared to what WepPageTest can do. There's no way to tell the visual completeness of the whole page from client-side code.",
							{
								"em": "anything"
							},
							"This fundamental difference means that some performance improvements can improve SpeedIndex, while not changing firstPaint or any other Navigation Timing metric. It's unfortunate in the sense that we know performance has improved, we just can't measure how much it did in the real world for our users. This is exactly what we were seeing here, real user metrics didn't improve during that period. Which doesn't mean that performance didn't really improve for people. As we'll see later, it did. It's also fundamental to understand that Navigation Timing is only a partial view of performance, and that some performance changes simply cannot be measured from real user data at this time.",
							{
								"a": {
									"href": "http://wpt.wmftest.org/",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "our public WebPageTest instance"
								},
								"strong": "test history"
							},
							{
								"div": {
									"class": "phabricator-remarkup-embed-layout-left",
									"a": {
										"href": "https://phab.wmfusercontent.org/file/data/qf4fjawhex4ssrlivua7/PHID-FILE-q6zq6olrl24jkk7p6ic2/Capture_d_e%CC%81cran_2017-05-30_13.47.38.png",
										"class": "phabricator-remarkup-embed-image-full",
										"data-sigil": "lightboxable",
										"data-meta": "0_13",
										"rel": "noreferrer",
										"img": {
											"src": "https://phab.wmfusercontent.org/file/data/qf4fjawhex4ssrlivua7/PHID-FILE-q6zq6olrl24jkk7p6ic2/Capture_d_e%CC%81cran_2017-05-30_13.47.38.png",
											"height": "265",
											"width": "1002"
										}
									}
								}
							},
							{
								"strong": "show tests from all users"
							},
							{
								"div": {
									"class": "phabricator-remarkup-embed-layout-left",
									"a": {
										"href": "https://phab.wmfusercontent.org/file/data/3ql634biebe3rkurc73y/PHID-FILE-a3yg6eucbu7cx23ex3z5/Capture_d_e%CC%81cran_2017-05-30_13.49.07.png",
										"class": "phabricator-remarkup-embed-image-full",
										"data-sigil": "lightboxable",
										"data-meta": "0_14",
										"rel": "noreferrer",
										"img": {
											"src": "https://phab.wmfusercontent.org/file/data/3ql634biebe3rkurc73y/PHID-FILE-a3yg6eucbu7cx23ex3z5/Capture_d_e%CC%81cran_2017-05-30_13.49.07.png",
											"height": "471",
											"width": "1002"
										}
									}
								}
							},
							"We test a number of pages for the desktop and mobile site, using various simulated internet connection speeds, etc. Finding the tests you're interested in in this history view requires manual labour, as you need to manually search for the labels you're interested in, the search box only applying to the URL.",
							"WebPageTest supports a great feature to compare different runs from the history view. We won't get into that here, though, as the difference is visible from the screenshot of the runs alone. After combing through the history view, I found two runs of the same test (the Sweden article on English Wikipedia, browsing the mobile site on Chrome with a simulated 3G connection.) before and after the SpeedIndex drop.",
							{
								"a": {
									"href": "http://wpt.wmftest.org/result/170524_KJ_9Z/",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "Before"
								}
							},
							{
								"div": {
									"class": "phabricator-remarkup-embed-layout-left",
									"a": {
										"href": "https://phab.wmfusercontent.org/file/data/httblcplhajjtarkhduq/PHID-FILE-mnp6ibsfr5o3suemcz5q/1_screen_thumb_%284%29.jpg",
										"class": "phabricator-remarkup-embed-image-full",
										"data-sigil": "lightboxable",
										"data-meta": "0_15",
										"rel": "noreferrer",
										"img": {
											"src": "https://phab.wmfusercontent.org/file/data/httblcplhajjtarkhduq/PHID-FILE-mnp6ibsfr5o3suemcz5q/1_screen_thumb_%284%29.jpg",
											"height": "354",
											"width": "250"
										}
									}
								}
							},
							{
								"a": {
									"href": "http://wpt.wmftest.org/result/170524_00_SW/",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "After"
								}
							},
							{
								"div": {
									"class": "phabricator-remarkup-embed-layout-left",
									"a": {
										"href": "https://phab.wmfusercontent.org/file/data/haqnkjqmhwrod4o5fkxo/PHID-FILE-4odgcokiwawj4nfd3i2o/1_screen_thumb_%285%29.jpg",
										"class": "phabricator-remarkup-embed-image-full",
										"data-sigil": "lightboxable",
										"data-meta": "0_16",
										"rel": "noreferrer",
										"img": {
											"src": "https://phab.wmfusercontent.org/file/data/haqnkjqmhwrod4o5fkxo/PHID-FILE-4odgcokiwawj4nfd3i2o/1_screen_thumb_%285%29.jpg",
											"height": "354",
											"width": "250"
										}
									}
								}
							},
							"It's obvious that the content above the fold changed. The new version displays mostly text above the fold, where the old version had images. This explains the SpeedIndex improvement: it's faster to load text than an image, which means that users get content they can consume above the fold faster. This is more dramatic on slow connections, which is why this performance improvement showed up on our synthetic testing that simulated a 3G connection.",
							{
								"a": {
									"href": "https://wikitech.wikimedia.org/wiki/Server_Admin_Log",
									"class": "remarkup-link",
									"rel": "noreferrer",
									"$t": "Server Admin Log"
								}
							},
							"And sure enough, we found this log entry around the time of the performance change:",
							{
								"a": [
									{
										"href": "/T150325",
										"class": "phui-tag-view phui-tag-type-object ",
										"data-sigil": "hovercard",
										"data-meta": "0_19",
										"span": {
											"class": "phui-tag-core-closed",
											"span": {
												"class": "phui-tag-core phui-tag-color-object",
												"$t": "T150325: Move first paragraph before infobox on stable"
											}
										}
									},
									{
										"href": "https://en.wikipedia.org/wiki/Help:Infobox",
										"class": "remarkup-link",
										"rel": "noreferrer",
										"$t": "infobox"
									},
									{
										"href": "https://phabricator.wikimedia.org/p/phuedx/",
										"class": "phui-tag-view phui-tag-type-person ",
										"data-sigil": "hovercard",
										"data-meta": "0_20",
										"rel": "noreferrer",
										"span": {
											"class": "phui-tag-core phui-tag-color-person",
											"$t": "@phuedx"
										}
									}
								]
							}
						],
						"blockquote": [
							{
								"p": "The Speed Index is the average time at which visible parts of the page are displayed.  It is expressed in milliseconds and dependent on size of the view port."
							},
							{
								"p": {
									"a": {
										"href": "https://phabricator.wikimedia.org/T150325",
										"class": "phui-tag-view phui-tag-type-object ",
										"data-sigil": "hovercard",
										"data-meta": "0_18",
										"rel": "noreferrer",
										"span": {
											"class": "phui-tag-core-closed",
											"span": {
												"class": "phui-tag-core phui-tag-color-object",
												"$t": "T150325"
											}
										}
									}
								}
							}
						],
						"h2": [
							{
								"class": "remarkup-header",
								"$t": "Comparing synthetic testing and real user metrics"
							},
							{
								"class": "remarkup-header",
								"$t": "Comparing WebPageTest runs"
							},
							{
								"class": "remarkup-header",
								"$t": "Deliberate or accidental change?"
							}
						]
					}
				}
			}
		]
	}
}